name: Continuous Integration

on:
  workflow_dispatch:
  pull_request:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  check:
    name: Check
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: âš™ï¸ Install golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.6
          install-only: true

      - name: ðŸ“ Check lints and formatting
        run: just check

  test:
    name: Test
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ§ª Run unit tests
        run: just test

      - name: â¬†ï¸ Upload coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: test-coverage
          path: coverage.out

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-24.04
    needs: [check]
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ§ª Run integration tests
        run: go test -v -tags=integration -run TestIntegration ./tests/...

  build:
    needs: [test, integration-test, check]
    name: Build
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: âš™ï¸ Install dependencies
        run: just ci

      - name: ðŸ·ï¸ Get project version
        id: get_version
        run: echo "VERSION=$(grep '^const Version' cmd/gwaihir/version.go | cut -d '"' -f 2)" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Build binary
        run: just build-release ${{ steps.get_version.outputs.VERSION }}

      - name: â¬†ï¸ Upload binary artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: gwaihir-${{ github.sha }}
          path: bin/gwaihir

  security:
    name: Security Scan
    runs-on: ubuntu-24.04
    permissions:
      security-events: write
      contents: read
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: ðŸ”’ Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'

      - name: â¬†ï¸ Upload SARIF file
        uses: github/codeql-action/upload-sarif@7434149006143a4d75b82a2f411ef15b03ccc2d7
        with:
          sarif_file: results.sarif

  sonar:
    needs: [test, integration-test, check, build]
    name: Sonar Analysis
    runs-on: ubuntu-24.04
    steps:
      - name: ðŸ›¡ï¸ Harden the runner
        uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          egress-policy: audit

      - name: ðŸ“¦ Checkout
        if: github.event_name != 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Checkout
        if: github.event_name == 'pull_request'
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@93397bea11091df50f3d7e59dc26a7711a8bcfbe # v4.1.0
        with:
          go-version: '1.22.2'
          cache: true

      - name: âš’ï¸ Setup just
        uses: extractions/setup-just@e33e0265a09d6d736e2ee1e0eb685ef1de4669ff # v3
        with:
          just-version: "1.40.0"

      - name: â¬‡ï¸ Download test coverage report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7
        with:
          name: test-coverage
          path: ./

      - name: ðŸ·ï¸ Get project version
        id: get_version
        run: echo "VERSION=$(grep '^const Version' cmd/gwaihir/version.go | cut -d '"' -f 2)" >> $GITHUB_OUTPUT

      - name: ðŸ’¾ Cache SonarCloud packages
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar-${{ hashFiles('**/sonar-project.properties') }}
          restore-keys: ${{ runner.os }}-sonar

      - name: ðŸ” SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9 # v7.0.0
        with:
          args: >
            -Dsonar.scm.revision=${{ github.sha }}
            -Dsonar.projectVersion=${{ steps.get_version.outputs.VERSION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
